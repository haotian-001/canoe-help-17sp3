<!DOCTYPE html>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" lang="en-us" xml:lang="en-us" data-mc-search-type="Stem" data-mc-help-system-file-name="CANoeCANalyzer.xml" data-mc-path-to-help-system="../../../../" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic" data-mc-preload-images="false" data-mc-in-preview-mode="false">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta name="msapplication-config" content="../../../../Skins/Favicons/browserconfig.xml" />
        <link rel="apple-touch-icon" sizes="180x180" href="../../../../Skins/Favicons/apple-touch-icon.png" />
        <link rel="shortcut icon" href="../../../../Skins/Favicons/favicon-32x32.png" />
        <link rel="icon" sizes="96x96" href="../../../../Skins/Favicons/favicon-96x96.png" />
        <link rel="icon" sizes="32x32" href="../../../../Skins/Favicons/favicon-32x32.png" />
        <link rel="icon" sizes="16x16" href="../../../../Skins/Favicons/favicon-16x16.png" /><title>Diagnostics: Connection of the Communication Layer</title>
        <link href="../../../../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Styles.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Tablet.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Mobile.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Print.css" rel="stylesheet" type="text/css" data-mc-generated="True" />
        <link href="../../../Resources/Stylesheets/vTableMasterPageHeader.css" rel="stylesheet" data-mc-stylesheet-type="table" />
        <link href="../../../Resources/Stylesheets/vStylesheet.css" rel="stylesheet" type="text/css" />
        <style>/*&lt;meta /&gt;*/

.button.expand-all-button
{
	-pie-background: linear-gradient(#ffffff, #ffffff);
}

.button.remove-highlight-button
{
	-pie-background: linear-gradient(#ffffff, #ffffff);
}

.button.collapse-all-button
{
	-pie-background: linear-gradient(#ffffff, #ffffff);
}

.needs-pie
{
	behavior: url('../../../../Resources/Scripts/PIE-no-motw.htc');
}

</style>
        <link rel="apple-touch-icon" sizes="180x180" href="../../../../Skins/Favicons/apple-touch-icon.png" />
        <link rel="shortcut icon" href="../../../../Skins/Favicons/favicon-32x32.png" />
        <link rel="icon" sizes="96x96" href="../../../../Skins/Favicons/favicon-96x96.png" />
        <link rel="icon" sizes="32x32" href="../../../../Skins/Favicons/favicon-32x32.png" />
        <link rel="icon" sizes="16x16" href="../../../../Skins/Favicons/favicon-16x16.png" />
        <script src="../../../../Resources/Scripts/jquery.min.js" type="text/javascript">
        </script>
        <script src="../../../../Resources/Scripts/purify.min.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/require.min.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/require.config.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/foundation.min.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/plugins.min.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapGlobal.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapDom.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapUtilities.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapXhr.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapTextEffects.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapSlideshow.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapMessageBus.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapMessageBus.CrossFrame.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapDefault.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapMediaQueries.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapAccessibility.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapHelpSystem.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapAliasFile.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapTopicFeedback.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapFeedbackHelper.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapSkinHelper.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapToc.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapToc.Breadcrumbs.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapToc.MiniToc.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapToc.SideMenu.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapIndex.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapGlossary.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapParser.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapSearch.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapNavigateTopics.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapLms.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapELearning.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapTopic.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapFeedback.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapMicroContentComponent.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapSearchHelper.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapTopicElements.js" type="text/javascript" defer="defer">
        </script>
        <script src="../../../../Resources/Scripts/MadCapTriPane.js" type="text/javascript" defer="defer">
        </script>
        <script type="text/jscript" src="../../../Resources/vScripts/SyntaxHighlighting.js">
        </script>
        <script type="text/jscript" src="../../../Resources/vScripts/TabSwitch.js">
        </script>
        <script type="text/javascript" src="../../../Resources/vScripts/Vector.js">
        </script>
    </head>
    <body>
        <p class="MCWebHelpFramesetLink MCWebHelpFramesetLinkTop"><a href="../../../../CANoeCANalyzer.htm#Topics/CAPLFunctions/Diagnostics/CAPLfunctionsDiagnosticsConnectionCommunicationLayer.htm">Open topic with navigation</a>
        </p>
        <div class="Body">
            <div role="main" id="mc-main-content">
                <p class="StructurePath"><a href="../CAPLfunctions.htm" class="StructurePath MCXref xref xrefStructurePath">CAPL Functions</a> » <a href="CAPLfunctionsDiagnosticsOverview.htm" class="StructurePath">Diagnostics</a> » Connection of the Communication Layer</p>
                <h1><a name="aanchor10416"></a>
                    <MadCap:concept term="CAPLDiagnostics" /><a name="kanchor8382"></a><span class="mc-variable System.Title variable">Diagnostics: Connection of the Communication Layer</span>
                </h1>
                <p class="MenuPath">&#160;</p>
                <p class="AutoSearchFilterConcepts"><a name="aanchor10417"></a>
                    <MadCap:concept term="SFCAPLFunctions" />
                </p>
                <p data-mc-conditions="vConditions.CANoeOnly">The diagnostic commands in CAPL allow access to the diagnostic services and data using symbols that were defined in the CANdela description file. For communication, this data must be transmitted, where two ways are available:</p>
                <ul>
                    <li data-mc-conditions="vConditions.CANoeOnly">In a tester node or test module, a call to <a href="Functions/CAPLfunctionDiagSetTarget.htm">diagSetTarget</a> suffices. It will connect the tester to the ECU via the so called built-in diagnostic channel provided by <span class="Product">CANoe</span>.</li>
                    <li data-mc-conditions="vConditions.CANoeOnly">In an ECU simulation it is necessary to implement the <span class="bold">CAPL callback interface</span>. This interface consists of a set of functions implemented in CAPL that are called by <span class="Product">CANoe </span>to trigger actions, and special CAPL functions implemented by <span class="Product">CANoe </span>that forward transport protocol events to <span class="Product">CANoe</span>.</li>
                </ul>
                <p data-mc-conditions="vConditions.CANoeOnly">This interface may also be used in tester nodes and test modules if direct access to the transport protocol is necessary, e.g. to perform fault injection.</p>
                <h2 class="GroupBox" data-mc-conditions="vConditions.CANoeOnly"><a name="CAPLCallbackInterface" id="CAPLCallbackInterface"></a>CAPL Callback Interface for Diagnostics</h2>
                <ul>
                    <li data-mc-conditions="vConditions.CANoeOnly"><a href="Functions/CAPLfunctionDiagSetChannelParameters.htm">_Diag_SetChannelParameters</a>: This function is called by CANoe to indicate that a new communication "channel" to the ECU or tester should be opened. Typically the settings configured for the ECU are queried and the transport protocol layer is configured.</li>
                    <li data-mc-conditions="vConditions.CANoeOnly"><a href="Functions/CAPLfunctionDiagDataRequest.htm">_Diag_DataRequest</a>: CANoe triggers the sending of data to the peer, i.e. in an ECU simulation, the bytes representing the response primitive will be given to be forwarded to the transport protocol. In a tester, the bytes represent the request primitive.</li>
                    <li data-mc-conditions="vConditions.CANoeOnly"><a href="Functions/CAPLfunctionDiagSendFunctionalCallback.htm">_Diag_SendFunctional</a> (in testers only): CANoe triggers the functional sending of a request.</li>
                    <li data-mc-conditions="vConditions.CANoeOnly"><a href="Functions/CAPLfunctionDiagSetupChannelRequest.htm">_Diag_SetupChannelReq</a> (in testers only): For connection-oriented transport protocols the tester has to establish a communication channel to the ECU. Once the channel is available, the tester has to call <a href="Functions/CAPLfunctionDiagSetupChannelCon.htm">diag_SetupChannelCon</a>.</li>
                </ul>
                <p data-mc-conditions="vConditions.CANoeOnly">For connectionless transport protocols, <span class="SourceCode">Diag_SetupChannelCon</span> can be called immediately.</p>
                <p data-mc-conditions="vConditions.CANoeOnly">Depending on the transport protocol implementation used, the events the CAPL program receives have to be forwarded to <span class="Product">CANoe</span>. <br />Please refer to these functions for details:</p>
                <ul>
                    <li data-mc-conditions="vConditions.CANoeOnly"><a href="Functions/CAPLfunctionDiagDataInd.htm">diag_DataInd</a>
                    </li>
                    <li data-mc-conditions="vConditions.CANoeOnly"><a href="Functions/CAPLfunctionDiagErrorInd.htm">diag_ErrorInd</a>
                    </li>
                    <li data-mc-conditions="vConditions.CANoeOnly"><a href="Functions/CAPLfunctionDiagDataCon.htm">diag_DataCon</a>
                    </li>
                    <li data-mc-conditions="vConditions.CANoeOnly"><a href="Functions/CAPLfunctionDiagFirstFrameInd.htm">diag_FirstFrameInd</a>
                    </li>
                    <li data-mc-conditions="vConditions.CANoeOnly"><a href="Functions/CAPLfunctionDiagClosedChannelInd.htm">diag_ClosedChannelInd</a>
                    </li>
                    <li data-mc-conditions="vConditions.CANoeOnly"><a href="Functions/CAPLfunctionDiagSetDataSegmentation.htm">diag_SetDataSegmentation</a>
                    </li>
                    <li data-mc-conditions="vConditions.CANoeOnly"><a href="Functions/CAPLfunctionDiagSetupChannelCon.htm">diag_SetupChannelCon</a>
                    </li>
                </ul>
                <div data-mc-conditions="vConditions.CANoeOnly">
                    <p>A reference implementation of the <a href="javascript:startDemoLoader('AN-IND-1-012_CAPL_Callback_Interface.pdf')" class="ExecuteLink">CAPL Callback Interface in CANoe</a> is available for the networks CAN, LIN, FlexRay (FlexRay TP AUTOSAR and FlexRay TP ISO) and DoIP/HSFZ using typical transport protocols for those bus systems.</p>
                    <p>For special applications in the course of ECU test and development those functions may be modified e.g. for inducing transmission errors for robustness tests <MadCap:conditionalText data-mc-conditions="vConditions.vTESTstudioExcluded,CAPLFunctions.OnlineHelpOnly">(see help <a href="../../../../Subsystems/SML/Subsystems/OsekTP/Content/Topics/OsekTP/OsekTP.htm" data-mc-conditions="vConditions.HTML5Link">OSEK TP (CAN Transport Protocol</a>)</MadCap:conditionalText>.</p>
                    <p>The reference implementations are available as include files (*.cin) in the <span class="Product">CANoe</span> installation folder <span class="bold">Reusable\CAPL_Includes\Diagnostics</span> you find in the same directory like the <span class="Product">CANoe</span> sample configurations. </p>
                    <p>In order to use them, you simply need to do the following steps:</p>
                    <ol>
                        <li value="1">Include the respective CIN file into your CAPL simulation nodes, test nodes, test modules and test case libraries.</li>
                        <li value="2">Define the following global variables in your CAPL code:</li>
                    </ol>
                    <ul>
                        <li class="Indent"><span class="bold">char gECU[]</span>
                            <br />gECU is the name of the respective node, e.g. of a simulated ECU, necessary for identifying the node in case of error messages in the <a href="../../CANoeCANalyzer/Windows/Write/WriteWindow.htm" data-mc-exclude-action="unbind" data-mc-conditions="vConditions.vTESTstudioExcluded,CAPLFunctions.OnlineHelpOnly">Write Window</a>. In case of FlexRay, it needs to contain the name of the database node.</li>
                        <li class="Indent"><span class="bold">int cIsTester</span>
                            <br />cIsTester is aflag indicating whether the node serves as a tester (cIsTester=1) or an ECU (cIsTester=0).</li>
                    </ul>
                    <ol start="3">
                        <li value="3">Add the respective transport protocol DLL to your CAPL node as a component, either by assigning it in the network description database or by adding it in the <span class="GUI">Components</span> tab of the <span class="GUI">Node Configuration</span> dialog.</li>
                        <li value="4">Implement the diagnostics behavior of your CAPL node using CAPL diagnostics functions, <a href="EventProcedures/CAPLfunctionOnDiagRequest.htm">on diagRequest</a> and <a href="EventProcedures/CAPLfunctionOnDiagResponse.htm">on diagResponse</a> handlers.</li>
                        <li value="5">Make sure there is a link between the diagnostic description and your CAPL code using the CAPL functions <a href="Functions/CAPLfunctionDiagSetTarget.htm">diagSetTarget</a> (in a <span class="bold">tester node</span>) or <a href="../KLine/Functions/CAPLfunctionDiagInitEcuSimulation.htm">diagInitEcuSimulation</a> (in an <span class="bold">ECU simulation</span>). Alternatively, you may choose <span class="GUI">Assign to database node</span> as usage of the diagnostic description in the <span class="GUI">Configuration|Diagnostics/ISO TP...</span> dialog (where available).</li>
                    </ol>
                    <p>The following example shows a very simple CAPL ECU simulation node.</p>
                    <p>You may add additional <a href="EventProcedures/CAPLfunctionOnDiagRequest.htm">on diagRequest &lt;service&gt;</a> handlers for all diagnostic services you want to support with your simulation and change the value of <span class="bold">gECU</span> to the ECU qualifier you defined in the <span class="GUI">Diagnostics/ISO TP…</span> dialog. Additionally, you might need to adapt the service name for the <span class="bold">Tester Present</span> service (in this example: <span class="bold">TesterPresent_Process</span>) to the service identifier specified in your diagnostic description:</p>
                    <p class="SourceCode">includes<br />{<br />&#160;&#160;// Include the CAPL Callback Interface (CCI) reference implementation for CAN TP<br />&#160;&#160;#include "Diagnostics\CCI_CanTP.cin"<br />}<br /><br />variables<br />{<br />&#160;&#160;// Define constants necessary for the CCI reference implementation<br />&#160;&#160;char gECU[20]="CAN_ECU"; // ECU qualifier defined in the<br />&#160;&#160;// "Configuration|Diagnostics/ISO TP..." dialog<br />&#160;&#160;int cIsTester=0;         // This is a simulation node, no tester node<br />}<br /><br />on preStart<br />{<br />&#160;&#160;// Provide the link to the configured diagnostic description<br />&#160;&#160;diagInitEcuSimulation(gECU);<br />}<br /><br />// Very simple implementation of diagnostics services supported by this simulation<br />// Only "Tester Present" is answered by a positive response, all other services by negative response<br />on diagRequest *<br />{<br />&#160;&#160;diagResponse this resp;<br />&#160;&#160;diagSendNegativeResponse(resp, 0x11); // Service not supported<br />}<br /><br />on diagRequest TesterPresent_Process<br />{<br />&#160;&#160;diagResponse this resp;<br />&#160;&#160;diagSendPositiveResponse(resp);<br />}</p>
                </div>
                <p class="LinkList"><a href="CAPLfunctionsDiagnosticsExpandedFunctions.htm" class="LinkList">Expanded Functions in CAPL</a>&#160;&#160;•&#160;&#160;<MadCap:conditionalText data-mc-conditions="vConditions.CANoeOnly"><a href="CAPLfunctionsDiagnosticsECUImplementation.htm" class="LinkList">Basic CAPL Procedure for an ECU Implementation</a>&#160;&#160;•&#160;&#160;</MadCap:conditionalText><a href="CAPLfunctionsDiagnosticsTestImplementation.htm" class="LinkList">Basic CAPL Procedure for a Tester Implementation</a></p>
            </div>
        </div>
        <div class="Footer">
            <div class="FooterWhite">
                <table class="FooterWhite" style="border-collapse: collapse;margin-left: auto;margin-right: auto;">
                    <col style="width: 70px;" data-mc-conditions="vConditions.HTML5Link" />
                    <col style="width: 16px;" data-mc-conditions="vConditions.HTML5Link" />
                    <col data-mc-conditions="" />
                    <col />
                    <tbody>
                        <tr>
                            <td>
                                <div class="buttons popup-container clearfix topicToolbarProxy topicToolbarProxyFooter _Skins_HTML5TopicToolbar mc-component nocontent">
                                    <div class="button-group-container-left">
                                        <button class="button needs-pie expand-all-button" data-state1-class="expand-all-button" data-state2-class="collapse-all-button" data-state2-title="Collapse all" title="Expand all" data-state1-title="Expand all">
                                            <div>
                                                <div role="img" class="button-icon-wrapper" aria-label="Expand all">
                                                    <div class="button-icon"> </div>
                                                </div>
                                            </div>
                                        </button>
                                        <button class="button needs-pie remove-highlight-button" title="Remove Highlights">
                                            <div>
                                                <div role="img" class="button-icon-wrapper">
                                                    <div class="button-icon"> </div>
                                                </div>
                                            </div>
                                        </button>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <p class="vec_BuildInfo"><a href="../../Shared/HowToUseOnlineHelp.htm" title="Tips for using the help" alt="Tips for using the help"><img src="../../../Resources/vImages/vBackstage/vHelpInfo.png" /></a>
                                </p>
                            </td>
                            <td>
                                <p class="vec_BuildInfo">•&#160;&#160;Technical&#160;References are only&#160;available&#160;in&#160;English</p>
                            </td>
                            <td>
                                <p class="vec_BuildInfo" style="text-align: right;"><span class="mc-variable Vector.BuildTime variable">2023-09-26T19:49:32</span>
                                </p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <table style="width: 100%;border-collapse: separate;border-spacing: 3px 0px;margin-left: auto;margin-right: auto;caption-side: top;">
                <col />
                <col />
                <col />
                <col data-mc-conditions="vConditions.HTML5Link" />
                <tbody>
                    <tr>
                        <td style="background-color: #b70032;padding-left: 5pt;padding-right: 5pt;padding-top: 5pt;padding-bottom: 5pt;">
                            <p class="vec_Footer">©&#160;Vector Informatik GmbH</p>
                        </td>
                        <td style="background-color: #b70032;padding-left: 5pt;padding-right: 5pt;padding-top: 5pt;padding-bottom: 5pt;text-align: right;">
                            <p class="vec_FooterBold">
                                <MadCap:conditionalText data-mc-conditions="vConditions.vTESTstudioExcluded,vConditions.TestDataEditorExcluded">CANoe</MadCap:conditionalText> Version <MadCap:conditionalText data-mc-conditions="vConditions.vTESTstudioExcluded">17 SP3</MadCap:conditionalText></p>
                        </td>
                        <td style="background-color: #b70032;padding-left: 5pt;padding-right: 5pt;padding-top: 5pt;padding-bottom: 0pt;text-align: right;">
                            <p class="vec_Footer"><a href="../../Shared/ContactCopyrightLicense.htm" class="vec_Footer MCXref xref xrefvec_Footer">Contact/Copyright/License</a>
                            </p>
                        </td>
                        <td style="background-color: #b70032;padding-left: 5pt;padding-right: 5pt;padding-top: 5pt;padding-bottom: 0pt;text-align: right;">
                            <p class="vec_Footer"><a href="https://www.vector.com/int/en/company/get-info/privacy-policy/" target="_blank" class="vec_Footer">Data Privacy Notice</a>
                            </p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </body>
</html>